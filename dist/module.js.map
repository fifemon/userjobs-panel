{"version":3,"sources":["../src/module.js"],"names":[],"mappings":"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","file":"module.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport _ from 'lodash';\nimport kbn from 'app/core/utils/kbn';\nimport TimeSeries from 'app/core/time_series';\n\nfunction background_style(value, limit) {\n    var bg;\n    if (value > limit) {\n        bg=' style=\"background-color:rgba(245, 54, 54, 0.9);color: white\"';\n    } else if (value > limit*0.9) {\n        bg=' style=\"background-color:rgba(237, 129, 40, 0.890196);color: black\"';\n    } else {\n        bg='';\n    }\n    return bg;\n}\n\nexport class UserJobsCtrl extends MetricsPanelCtrl {\n\n  constructor($scope, $injector, $rootScope, templateSrv) {\n    super($scope, $injector);\n    this.$rootScope = $rootScope;\n    this.templateSrv = templateSrv;\n\n    var panelDefaults = {\n        index: \"\",\n        query: \"*\",\n        userQuery: \"\",\n        mode: \"Completed\", // \"Active\",\"Completed\"\n        showIdle: true,\n        showRunning: true,\n        showHeld: true,\n        size: 100,\n        scroll: false\n    };\n\n    this.data = [];\n    this.docs = 0;\n    this.docsMissing = 0;\n    this.docsTotal = 0;\n    this.rowCount = 0;\n\n    _.defaults(this.panel, panelDefaults);\n\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n  }\n\n\n  onInitEditMode() {\n    this.addEditorTab('Options', 'public/plugins/fifemon-userjobs-panel/editor.html', 2);\n  }\n\n  issueQueries(datasource) {\n      this.updateTimeRange();\n      this.datasource=datasource;\n      return datasource._post(this.panel.index+'/'+'_search',this.get_clusters_query()).then(function(res) {\n          return {data: res};\n      });\n  }\n\n  onDataReceived(data) {\n      if (data) {\n          this.data = data.aggregations.cluster.buckets;\n          this.docsMissing = data.aggregations.cluster.sum_other_doc_count;\n          this.docsTotal = data.hits.total;\n          this.docs = this.docsTotal - this.docsMissing;\n          this.rowCount = this.data.length;\n      } else {\n          this.data = [];\n      }\n      this.render(this.data);\n  }\n\n  render() {\n      return super.render(this.data);\n  }\n\n  link(scope, elem, attrs, ctrl) {\n      var data;\n      var panel = ctrl.panel;\n      var pageCount = 0;\n\n      function getTableHeight() {\n          var panelHeight = ctrl.height;\n          /*if (pageCount > 1) {\n              panelHeight -= 26;\n          }*/\n          return (panelHeight - 31) + 'px';\n      }\n\n      function renderPanel() {\n          var root = elem.find('.table-panel-scroll');\n          root.css({'max-height': panel.scroll ? getTableHeight() : ''});\n\n          var tbody = elem.find('tbody');\n          renderTable(tbody);\n      }\n\n      function renderTable(tbody) {\n          tbody.empty();\n          var html = '';\n          for (var i = 0; i < data.length; i++) {\n              html += renderActiveRow(data[i]);\n          }\n          tbody.html(html);\n      }\n\n      function renderActiveRow(data) {\n          var schedd = data['cmd']['hits']['hits'][0]['_source']['schedd'];\n          var cmd = data['cmd']['hits']['hits'][0]['_source']['Cmd'].split('/').pop();\n          var bg_hold = background_style(data['status']['buckets']['held']['doc_count']*100,1.0);\n          var request_mem = data['request_mem']['value']*1;\n          var max_mem = data['max_mem']['value']/1024;\n          var bg_mem=background_style(max_mem,request_mem);\n          var request_disk = data['request_disk']['value']/1024;\n          var max_disk = data['max_disk']['value']/1024;\n          var bg_disk=background_style(max_disk,request_disk);\n          var max_cputime = data['max_cputime']['value']/3600;\n          var max_walltime = data['max_walltime']['value']/3600;\n          var efficiency=\"----\";\n          if (max_walltime > 0) {\n              efficiency = (max_cputime/max_walltime*100).toFixed(1)+'%';\n          }\n          var request_time = data['request_walltime']['value']/3600;\n          var bg_time=background_style(max_walltime,request_time);\n          var html = '<tr>'+\n              '<td rowspan=\"2\"><a style=\"text-decoration:underline;\" href=\"dashboard/db/job-cluster-summary?var-cluster='+data['key']+'&var-schedd='+schedd+'&from='+ctrl.rangeRaw.from+'&to='+ctrl.rangeRaw.to+'\">'+data['key']+'@'+schedd+'</a></td>';\n          if (panel.mode === 'Active') {\n              html += '<td rowspan=\"2\">'+data['status']['buckets']['idle']['doc_count']+'</td>'+\n              '<td rowspan=\"2\">'+data['status']['buckets']['running']['doc_count']+'</td>'+\n              '<td rowspan=\"2\"' + bg_hold + '>'+data['status']['buckets']['held']['doc_count']+'</td>';\n          }\n          html += '<td>'+data['submit_date']['value_as_string']+'</td>'+\n              '<td' + bg_mem + '>' + max_mem.toFixed(0) + ' / ' + request_mem.toFixed(0) +'</td>'+\n              '<td' + bg_disk + '>' + max_disk.toFixed(0) + ' / ' + request_disk.toFixed(0) +'</td>'+\n              '<td' + bg_time + '>' + max_walltime.toFixed(0) + ' / ' + request_time.toFixed(0) +'</td>'+\n              //'<td>'+ max_cputime.toFixed(2) +' hr</td>'+\n              '<td>'+ efficiency +'</td>'+\n              '<td>'+data['max_restarts'].value+'&nbsp;&nbsp;&nbsp;&nbsp;</td>'+\n              '</tr><tr><td colspan=\"6\" class=\"job-command\">'+cmd+'</td>'+\n              '</tr>';\n          return html;\n      }\n\n\n      ctrl.events.on('render', function(renderData) {\n          data = renderData || data;\n          if (data) {\n              renderPanel();\n          }\n          ctrl.renderingCompleted();\n      });\n  }\n\n  get_clusters_query() {\n      var q = this.templateSrv.replace(this.panel.query, this.panel.scopedVars);\n      if (this.panel.userQuery !== '') {\n          q += ' AND ' + this.panel.userQuery;\n      }\n\n      var from = this.rangeRaw.from;\n      var to = this.rangeRaw.to;\n      // time range hack; really should have separate indices for active and completed jobs\n      if (this.panel.mode === 'Active') {\n          from = 'now-10m';\n          to = 'now';\n      } else if (this.panel.mode === 'Completed' && to === 'now') {\n          to = 'now-10m';\n      }\n\n      var data = {\n          \"size\": 0,\n          \"query\": {\n              \"filtered\": {\n                  \"query\": {\n                      \"query_string\": { \"query\": q }\n                  },\n                  \"filter\": {\n                      \"range\": { \"timestamp\": { \"gte\": from, \"lte\": to }}\n                  }\n              }\n          },\n          \"aggs\": {\n              \"cluster\": {\n                  \"terms\": {\n                      \"field\": \"cluster\",\n                      \"size\": this.panel.size,\n                      \"order\" : { \"submit_date\" : \"asc\" }\n                  },\n                  \"aggs\": {\n                      \"max_mem\": {\n                          \"max\": {\n                              \"field\": \"ResidentSetSize_RAW\"\n                          }\n                      },\n                      \"request_mem\": {\n                          \"min\": {\n                              \"field\": \"RequestMemory\"\n                          }\n                      },\n                      \"max_disk\": {\n                          \"max\": {\n                              \"field\": \"DiskUsage_RAW\"\n                          }\n                      },\n                      \"request_disk\": {\n                          \"min\": {\n                              \"field\": \"RequestDisk\"\n                          }\n                      },\n                      \"submit_date\": {\n                          \"max\": {\n                              \"field\": \"submit_date\"\n                          }\n                      },\n                      \"max_restarts\": {\n                          \"max\": {\n                              \"field\": \"NumJobStarts\"\n                          }\n                      },\n                      \"max_cputime\": {\n                          \"max\": {\n                              \"field\": \"RemoteUserCpu\"\n                          }\n                      },\n                      \"max_walltime\": {\n                          \"max\": {\n                              \"field\": \"walltime\"\n                          }\n                      },\n                      \"request_walltime\": {\n                          \"max\": {\n                              \"field\": \"JOB_EXPECTED_MAX_LIFETIME\"\n                          }\n                      },\n                      \"cmd\": {\n                          \"top_hits\": {\n                              \"size\": 1,\n                              \"_source\": {\n                                  \"include\": [\"Cmd\", \"schedd\"]\n                              }\n                          }\n                      },\n                      \"status\": {\n                          \"filters\": {\n                              \"filters\": {\n                                  \"idle\": { \"term\": { \"status\": 1 }},\n                                  \"running\": { \"term\": { \"status\": 2 }},\n                                  \"cancelled\": { \"term\": { \"status\": 3 }},\n                                  \"complete\": { \"term\": { \"status\": 4 }},\n                                  \"held\": { \"term\": { \"status\": 5 }}\n                              }\n                          }\n                      }\n                  }\n              }\n          }\n      };\n      return data;\n  }\n\n}\n\nUserJobsCtrl.templateUrl = 'module.html';\n\nexport {\n  UserJobsCtrl as PanelCtrl\n};\n\n"]}