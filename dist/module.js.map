{"version":3,"sources":["../src/module.js"],"names":[],"mappings":"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","file":"module.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport _ from 'lodash';\nimport kbn from 'app/core/utils/kbn';\nimport TimeSeries from 'app/core/time_series';\n\nfunction background_style(value, limit) {\n    var bg;\n    if (value > limit) {\n        bg=' style=\"background-color:rgba(245, 54, 54, 0.9);color: white\"';\n    } else if (value > limit*0.9) {\n        bg=' style=\"background-color:rgba(237, 129, 40, 0.890196);color: black\"';\n    } else {\n        bg='';\n    }\n    return bg;\n}\n\nexport class UserJobsCtrl extends MetricsPanelCtrl {\n\n  constructor($scope, $injector, $rootScope) {\n    super($scope, $injector);\n    this.$rootScope = $rootScope;\n\n    var panelDefaults = {\n        index: \"\",\n        query: \"*\",\n        userQuery: \"\",\n        mode: \"Completed\", // \"Active\",\"Completed\"\n        showIdle: true,\n        showRunning: true,\n        showHeld: true,\n        size: 100,\n        scroll: false\n    };\n\n    _.defaults(this.panel, panelDefaults);\n\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n  }\n\n\n  onInitEditMode() {\n    this.addEditorTab('Options', 'public/plugins/fifemon-userjobs-panel/editor.html', 2);\n  }\n\n  issueQueries(datasource) {\n      this.updateTimeRange();\n      this.datasource=datasource;\n      return datasource._post(this.panel.index+'/'+'_search',this.get_clusters_query()).then(function(res) {\n          return {data: res};\n      });\n  }\n\n  onDataReceived(data) {\n      if (data) {\n          this.data = data['aggregations']['cluster']['buckets'];\n      } else {\n          this.data = [];\n      }\n      this.render(this.data);\n  }\n\n  render() {\n      return super.render(this.data);\n  }\n\n  link(scope, elem, attrs, ctrl) {\n      var data;\n      var panel = ctrl.panel;\n      var pageCount = 0;\n\n      function renderPanel() {\n          var tbody = elem.find('tbody');\n          renderTable(tbody);\n      }\n\n      function renderTable(tbody) {\n          tbody.empty();\n          var html = '';\n          for (var i = 0; i < data.length; i++) {\n              html += renderActiveRow(data[i]);\n          }\n          tbody.html(html);\n      }\n\n      function renderActiveRow(data) {\n          var schedd = data['cmd']['hits']['hits'][0]['_source']['schedd'];\n          var cmd = data['cmd']['hits']['hits'][0]['_source']['Cmd'].split('/').pop();\n          var bg_hold = background_style(data['status']['buckets']['held']['doc_count']*100,1.0);\n          var request_mem = data['request_mem']['value']*1;\n          var max_mem = data['max_mem']['value']/1024;\n          var bg_mem=background_style(max_mem,request_mem);\n          var request_disk = data['request_disk']['value']/1024;\n          var max_disk = data['max_disk']['value']/1024;\n          var bg_disk=background_style(max_disk,request_disk);\n          var max_cputime = data['max_cputime']['value']/3600;\n          var max_walltime = data['max_walltime']['value']/3600;\n          var efficiency=\"----\";\n          if (max_walltime > 0) {\n              efficiency = (max_cputime/max_walltime*100).toFixed(1)+'%';\n          }\n          var request_time = data['request_walltime']['value']/3600;\n          var bg_time=background_style(max_walltime,request_time);\n          return '<tr>'+\n              '<td rowspan=\"2\"><a style=\"text-decoration:underline;\" href=\"dashboard/db/job-cluster-summary?var-cluster='+data['key']+'&var-schedd='+schedd+'\">'+data['key']+'@'+schedd+'</a></td>'+\n              '<td rowspan=\"2\">'+data['status']['buckets']['idle']['doc_count']+'</td>'+\n              '<td rowspan=\"2\">'+data['status']['buckets']['running']['doc_count']+'</td>'+\n              '<td rowspan=\"2\"' + bg_hold + '>'+data['status']['buckets']['held']['doc_count']+'</td>'+\n              '<td>'+data['submit_date']['value_as_string']+'</td>'+\n              '<td' + bg_mem + '>' + max_mem.toFixed(0) + ' / ' + request_mem.toFixed(0) +'</td>'+\n              '<td' + bg_disk + '>' + max_disk.toFixed(0) + ' / ' + request_disk.toFixed(0) +'</td>'+\n              '<td' + bg_time + '>' + max_walltime.toFixed(0) + ' / ' + request_time.toFixed(0) +'</td>'+\n              //'<td>'+ max_cputime.toFixed(2) +' hr</td>'+\n              '<td>'+ efficiency +'</td>'+\n              '<td>'+data['max_restarts'].value+'&nbsp;&nbsp;&nbsp;&nbsp;</td>'+\n              '</tr><tr><td colspan=\"6\" class=\"job-command\">'+cmd+'</td>'+\n              '</tr>';\n      }\n\n\n      ctrl.events.on('render', function(renderData) {\n          data = renderData || data;\n          if (data) {\n              renderPanel();\n          }\n          ctrl.renderingCompleted();\n      });\n  }\n\n  get_clusters_query() {\n      var q = this.panel.query;\n      if (this.panel.userQuery !== '') {\n          q += ' AND ' + this.panel.userQuery;\n      }\n\n      var from = this.dashboard.time.from;\n      var to = this.dashboard.time.to;\n      if (this.panel.mode === 'Active') {\n          from = 'now-10m';\n          to = 'now';\n      }\n\n      var data = {\n          \"size\": 0,\n          \"query\": {\n              \"filtered\": {\n                  \"query\": {\n                      \"query_string\": { \"query\": q }\n                  },\n                  \"filter\": {\n                      \"range\": { \"timestamp\": { \"gte\": from, \"lte\": to }}\n                  }\n              }\n          },\n          \"aggs\": {\n              \"cluster\": {\n                  \"terms\": {\n                      \"field\": \"cluster\",\n                      \"size\": this.panel.size,\n                      \"order\" : { \"submit_date\" : \"asc\" }\n                  },\n                  \"aggs\": {\n                      \"max_mem\": {\n                          \"max\": {\n                              \"field\": \"ResidentSetSize_RAW\"\n                          }\n                      },\n                      \"request_mem\": {\n                          \"min\": {\n                              \"field\": \"RequestMemory\"\n                          }\n                      },\n                      \"max_disk\": {\n                          \"max\": {\n                              \"field\": \"DiskUsage_RAW\"\n                          }\n                      },\n                      \"request_disk\": {\n                          \"min\": {\n                              \"field\": \"RequestDisk\"\n                          }\n                      },\n                      \"submit_date\": {\n                          \"max\": {\n                              \"field\": \"submit_date\"\n                          }\n                      },\n                      \"max_restarts\": {\n                          \"max\": {\n                              \"field\": \"NumJobStarts\"\n                          }\n                      },\n                      \"max_cputime\": {\n                          \"max\": {\n                              \"field\": \"RemoteUserCpu\"\n                          }\n                      },\n                      \"max_walltime\": {\n                          \"max\": {\n                              \"field\": \"walltime\"\n                          }\n                      },\n                      \"request_walltime\": {\n                          \"max\": {\n                              \"field\": \"JOB_EXPECTED_MAX_LIFETIME\"\n                          }\n                      },\n                      \"cmd\": {\n                          \"top_hits\": {\n                              \"size\": 1,\n                              \"_source\": {\n                                  \"include\": [\"Cmd\", \"schedd\"]\n                              }\n                          }\n                      },\n                      \"status\": {\n                          \"filters\": {\n                              \"filters\": {\n                                  \"idle\": { \"term\": { \"status\": 1 }},\n                                  \"running\": { \"term\": { \"status\": 2 }},\n                                  \"cancelled\": { \"term\": { \"status\": 3 }},\n                                  \"complete\": { \"term\": { \"status\": 4 }},\n                                  \"held\": { \"term\": { \"status\": 5 }}\n                              }\n                          }\n                      }\n                  }\n              }\n          }\n      };\n      return data;\n  }\n\n\n  /*\n  setUnitFormat(subItem) {\n    this.panel.format = subItem.value;\n    this.render();\n  }\n\n  onDataError() {\n    this.series = [];\n    this.render();\n  }\n\n  changeSeriesColor(series, color) {\n    series.color = color;\n    this.panel.aliasColors[series.alias] = series.color;\n    this.render();\n  }\n\n  onRender() {\n    this.data = this.parseSeries(this.series);\n  }\n\n  parseSeries(series) {\n    return _.map(this.series, (serie, i) => {\n      return {\n        label: serie.alias,\n        data: serie.stats[this.panel.valueName],\n        color: this.panel.aliasColors[serie.alias] || this.$rootScope.colors[i]\n      };\n    });\n  }\n\n\n  seriesHandler(seriesData) {\n    var series = new TimeSeries({\n      datapoints: seriesData.datapoints,\n      alias: seriesData.target\n    });\n\n    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\n    return series;\n  }\n\n  getDecimalsForValue(value) {\n    if (_.isNumber(this.panel.decimals)) {\n      return { decimals: this.panel.decimals, scaledDecimals: null };\n    }\n\n    var delta = value / 2;\n    var dec = -Math.floor(Math.log(delta) / Math.LN10);\n\n    var magn = Math.pow(10, -dec);\n    var norm = delta / magn; // norm is between 1.0 and 10.0\n    var size;\n\n    if (norm < 1.5) {\n      size = 1;\n    } else if (norm < 3) {\n      size = 2;\n      // special case for 2.5, requires an extra decimal\n      if (norm > 2.25) {\n        size = 2.5;\n        ++dec;\n      }\n    } else if (norm < 7.5) {\n      size = 5;\n    } else {\n      size = 10;\n    }\n\n    size *= magn;\n\n    // reduce starting decimals if not needed\n    if (Math.floor(value) === value) { dec = 0; }\n\n    var result = {};\n    result.decimals = Math.max(0, dec);\n    result.scaledDecimals = result.decimals - Math.floor(Math.log(size) / Math.LN10) + 2;\n\n    return result;\n  }\n\n  formatValue(value) {\n    var decimalInfo = this.getDecimalsForValue(value);\n    var formatFunc = kbn.valueFormats[this.panel.format];\n    if (formatFunc) {\n      return formatFunc(value, decimalInfo.decimals, decimalInfo.scaledDecimals);\n    }\n    return value;\n  }\n\n  */\n}\n\nUserJobsCtrl.templateUrl = 'module.html';\n\nexport {\n  UserJobsCtrl as PanelCtrl\n};\n\n"]}